name: Nightly Smoke

on:
  schedule:
    # Run at 2:30 AM UTC daily
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      run_date:
        description: 'Override run date (YYYY-MM-DD format)'
        required: false
        type: string

# Only one nightly smoke run at a time
concurrency:
  group: nightly-smoke
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.13"

jobs:
  smoke:
    name: Nightly Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Compute run date
        id: dates
        run: |
          if [[ -n "${{ inputs.run_date }}" ]]; then
            echo "today=${{ inputs.run_date }}" >> "$GITHUB_OUTPUT"
          else
            echo "today=$(date -u +%F)" >> "$GITHUB_OUTPUT"
          fi

      - name: Write .env for automation
        env:
          API_BASE_URL: ${{ secrets.MDWB_API_BASE_URL }}
          MDWB_API_KEY: ${{ secrets.MDWB_API_KEY }}
          OLMOCR_SERVER: ${{ secrets.OLMOCR_SERVER }}
          OLMOCR_API_KEY: ${{ secrets.OLMOCR_API_KEY }}
        run: |
          cat <<EOF > .env
          API_BASE_URL=${API_BASE_URL:-https://mdwb.example.com}
          MDWB_API_KEY=${MDWB_API_KEY}
          OLMOCR_SERVER=${OLMOCR_SERVER:-https://ai2endpoints.cirrascale.ai/api}
          OLMOCR_API_KEY=${OLMOCR_API_KEY}
          OLMOCR_MODEL=olmOCR-2-7B-1025-FP8
          OCR_USE_FP8=true
          TILE_LONG_SIDE_PX=1288
          TILE_OVERLAP_PX=120
          VIEWPORT_OVERLAP_PX=120
          CAPTURE_VIEWPORT_WIDTH=1280
          CAPTURE_VIEWPORT_HEIGHT=2000
          CAPTURE_DEVICE_SCALE_FACTOR=2
          CAPTURE_COLOR_SCHEME=light
          CFT_VERSION=chrome-130.0.6723.69
          CFT_LABEL=Stable-1
          PLAYWRIGHT_CHANNEL=cft
          PLAYWRIGHT_TRANSPORT=cdp
          OCR_MIN_CONCURRENCY=2
          OCR_MAX_CONCURRENCY=8
          CACHE_ROOT=.cache
          RUNS_DB_PATH=runs.db
          PROMETHEUS_PORT=9000
          HTMX_SSE_HEARTBEAT_MS=4000
          BLOCKLIST_PATH=config/blocklist.json
          SCROLL_SHRINK_WARNING_THRESHOLD=1
          OVERLAP_WARNING_RATIO=0.65
          WARNING_LOG_PATH=ops/warnings.jsonl
          EOF

      - name: Install Playwright browsers
        run: uv run playwright install --with-deps chromium

      - name: Check environment completeness
        run: uv run python scripts/check_env.py --env .env

      - name: Run nightly smoke
        id: smoke
        env:
          RUN_DATE: ${{ steps.dates.outputs.today }}
        run: |
          uv run python scripts/run_smoke.py --date "$RUN_DATE"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-smoke-${{ steps.dates.outputs.today }}
          path: benchmarks/production/${{ steps.dates.outputs.today }}
          retention-days: 30

      - name: Upload smoke logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs-${{ steps.dates.outputs.today }}
          path: |
            *.log
            tmp/*.log
          retention-days: 7
          if-no-files-found: ignore
